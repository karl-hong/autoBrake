C51 COMPILER V9.55   MAIN                                                                  01/11/2024 00:19:13 PAGE 1   


C51 COMPILER V9.55, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil_C51\C51\BIN\C51.EXE ..\user\main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\h
                    -al;..\user) DEBUG OBJECTEXTEND PRINT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #define ALLOCATE_EXTERN
   2          #include "HC89S003AF4.h"
   3          #include "clock.h"
   4          #include "my_printf.h"
   5          #include <stdio.h>
   6          #include "typedef.h"
   7          #include "gpio.h"
   8          #include "led.h"
   9          #include "ie.h"
  10          #include "common.h"
  11          #include "key.h"
  12          #include "bat.h"
  13          
  14          uint16_t cnt = 0;
  15          main_context_t gMainContext;
  16          
  17          void Delay_ms(unsigned int fui_i);
  18          void timer0_init(void);
  19          
  20          void main(void)
  21          {
  22   1           char test = 0;
  23   1        WDTCCR = 0x00;            //关闭看门狗
  24   1           /* init clock */
  25   1           clock_enable(CLK_EN_INTERNAL);
  26   1           clock_set_source(CLKSEL_INTERNEL_HIGH_RC);
  27   1           clock_set_rc32m_div(RC32M_CLK_2);//Fosc = 16M
  28   1           clock_set_cpu_div(1);//Fcpu = Fosc，由于串口需要Fosc = Fcpu
  29   1      
  30   1           /* init uart1 */
  31   1           UART1_Init();
  32   1           /* led init */
  33   1           led_init();
  34   1           /* timer init */
  35   1           timer0_init();
  36   1           /* key init */
  37   1           key_init();
  38   1           /* check bat init */
  39   1           bat_init();
  40   1      
  41   1           /* enable interrupt */
  42   1           user_set_interrupt_state(IE_TYPE_GLOBAL, IE_ENABLE);
  43   1      
  44   1           while(1){
  45   2                // // key_task();
  46   2                check_bat_task();
  47   2                bat_led_task();
  48   2           }
  49   1      
  50   1      }
  51          
  52          
  53          void Delay_ms(unsigned int fui_i)
  54          {
C51 COMPILER V9.55   MAIN                                                                  01/11/2024 00:19:13 PAGE 2   

  55   1        unsigned int fui_j;
  56   1        for(;fui_i > 0;fui_i --)
  57   1        for(fui_j = 1596;fui_j > 0;fui_j --);
  58   1      }
  59          
  60          void timer0_init(void)
  61          {
  62   1        TCON1 = 0x00;             //Tx0定时器时钟为Fosc
  63   1        TMOD = 0x00;              //16位重装载定时器/计数器
  64   1      
  65   1        //Tim0计算时间  = (65536 - 0xFACB) * (1 / (Fosc /Timer分频系数))
  66   1        //        = 1333 / (16000000 / 12)
  67   1        //        = 1 ms
  68   1      
  69   1        //定时1ms
  70   1        //反推初值  = 65536 - ((1/1000) / (1/(Fosc / Timer分频系数)))
  71   1        //        = 65536 - ((1/1000) / (1/(16000000 / 12)))
  72   1        //      = 65536 - 1333
  73   1        //      = 0xFACB
  74   1        TH0 = 0xFA;
  75   1        TL0 = 0xCB;               //T0定时时间1ms
  76   1        IE |= 0x02;               //打开T0中断
  77   1        TCON |= 0x10;             //使能T0
  78   1      }
  79          
  80          /***************************************************************************************
  81            * @说明   T0中断服务函数
  82            * @参数   无
  83            * @返回值 无
  84            * @注      无
  85          ***************************************************************************************/
  86          void TIMER0_Rpt(void) interrupt TIMER0_VECTOR
  87          { /* 1ms */
  88   1        gMainContext.mKeyDelay = true;
  89   1           gMainContext.mBatDelay = true;
  90   1           gMainContext.mLedDelay = true;
  91   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    117    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      6       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
